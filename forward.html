<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Forward References</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Forward References</h1>
<div class="slides">
<div>
<div>
<h1>Forward References</h1>
</div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Forward</span> {<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="type">enum</span> <span class="keyword">class</span> <span class="type">Cmd_Style</span> {<br/>
<span class="in4"></span><span class="var">i_type</span>, <span class="var">s_type</span>, <span class="var">b_type</span>,<br/>
<span class="in4"></span><span class="var">u_type</span>, <span class="var">j_type</span><br/>
<span class="in3"></span>};<br/>
<span class="in2"></span><span class="keyword">private</span>:<br/>
<span class="in3"></span><span class="type">Cmd_Style</span> <span class="var">_style</span>;<br/>
<span class="in3"></span><span class="type">int</span> <span class="var">_position</span>;<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">_name</span>;<br/>
<span class="in3"></span><span class="type">bool</span> <span class="var">_relative</span>;<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">Forward</span>(<span class="type">Cmd_Style</span> <span class="var">style</span>, <span class="type">int</span> <span class="var">position</span>, <span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>, <span class="type">bool</span> <span class="var">relative</span>):<br/>
<span class="in4"></span><span class="var">_style</span> { <span class="var">style</span> }, <span class="var">_position</span> { <span class="var">position</span> }, <span class="var">_name</span> { <span class="var">name</span> }, <span class="var">_relative</span> { <span class="var">relative</span> }<br/>
<span class="in3"></span>{ }<br/>
<span class="in3"></span><span class="type">Cmd_Style</span> <span class="fn">style</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_style</span>; }<br/>
<span class="in3"></span><span class="type">int</span> <span class="fn">position</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_position</span>; }<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> <span class="fn">name</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_name</span>; }<br/>
<span class="in3"></span><span class="type">bool</span> <span class="fn">relative</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_relative</span>; }<br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">State</span>;<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Forwards</span> {<br/>
<span class="in2"></span><span class="keyword">private</span>:<br/>
<span class="in3"></span><span class="keyword">using</span> <span class="type">Container</span> = <span class="type">std</span>::<span class="type">vector</span>&lt;<span class="type">Forward</span>&gt;;<br/>
<span class="in3"></span><span class="type">Container</span> <span class="var">_forwards</span>;<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="type">void</span> <span class="fn">emplace_back</span>(<br/>
<span class="in4"></span><span class="type">Forward</span>::<span class="type">Cmd_Style</span> <span class="var">style</span>, <span class="type">int</span> <span class="var">position</span>, <span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>, <span class="type">bool</span> <span class="var">relative</span><br/>
<span class="in3"></span>) {<br/>
<span class="in4"></span><span class="var">_forwards</span>.<span class="fn">emplace_back</span>(<br/>
<span class="in5"></span><span class="var">style</span>, <span class="var">position</span>, <span class="var">name</span>, <span class="var">relative</span><br/>
<span class="in4"></span>);<br/>
<span class="in3"></span>}<br/>
<span class="in3"></span><span class="type">void</span> <span class="fn">fill</span>(<br/>
<span class="in4"></span><span class="type">const</span> <span class="type">Macros</span> &amp;<span class="var">macros</span>,<br/>
<span class="in4"></span><span class="type">State</span> &amp;<span class="var">state</span><br/>
<span class="in3"></span>);<br/>
<span class="in1"></span>};<br/>
<span class="macro">@End(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">needed by main</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="type">Forwards</span>::<span class="fn">fill</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Macros</span> &amp;<span class="var">macros</span>,<br/>
<span class="in2"></span><span class="type">State</span> &amp;<span class="var">state</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">f</span> : <span class="var">_forwards</span>) {<br/>
<span class="in3"></span><span class="type">bool</span> <span class="var">found</span> { <span class="num">false</span> };<br/>
<span class="in3"></span><span class="type">int</span> <span class="var">value</span>;<br/>
<span class="in3"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">m</span> : <span class="var">macros</span>) {<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">m</span>.<span class="fn">pattern</span>().<span class="fn">size</span>() == <span class="num">1</span>) {<br/>
<span class="in5"></span><span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">p</span> { *<span class="var">m</span>.<span class="fn">pattern</span>().<span class="fn">begin</span>() };<br/>
<span class="in5"></span><span class="keyword">if</span> (<span class="var">p</span>.<span class="fn">type</span>() == <span class="type">Item_Type</span>::<span class="var">t_string</span> &amp;&amp; <span class="var">p</span>.<span class="fn">str</span>() == <span class="var">f</span>.<span class="fn">name</span>()) {<br/>
<span class="in6"></span><span class="keyword">if</span> (<span class="var">m</span>.<span class="fn">replacement</span>().<span class="fn">size</span>() == <span class="num">1</span>) {<br/>
<span class="in7"></span><span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">r</span> { *<span class="var">m</span>.<span class="fn">replacement</span>().<span class="fn">begin</span>() };<br/>
<span class="in7"></span><span class="keyword">if</span> (<span class="var">r</span>.<span class="fn">type</span>() == <span class="type">Item_Type</span>::<span class="var">t_instance</span> &amp;&amp; <span class="var">r</span>.<span class="fn">str</span>() == <span class="str">"num"</span>) {<br/>
<span class="in8"></span><span class="var">found</span> = <span class="num">true</span>;<br/>
<span class="in8"></span><span class="var">value</span> = <span class="var">r</span>.<span class="fn">value</span>();<br/>
<span class="in8"></span><span class="keyword">break</span>;<br/>
<span class="in7"></span>}<br/>
<span class="in6"></span>}<br/>
<span class="in5"></span>}<br/>
<span class="in4"></span>}<br/>
<span class="in3"></span>}<br/>
<span class="in3"></span><span class="keyword">if</span> (! <span class="var">found</span>) {<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"can't expand "</span> &lt;&lt; <span class="var">f</span>.<span class="fn">name</span>() &lt;&lt; <span class="str">'\n'</span>;<br/>
<span class="in4"></span><span class="keyword">continue</span>;<br/>
<span class="in3"></span>}<br/>
<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">f</span>.<span class="fn">relative</span>()) {<br/>
<span class="in4"></span><span class="var">value</span> = <span class="var">value</span> - <span class="num">4</span> * <span class="var">f</span>.<span class="fn">position</span>() - <span class="num">0x20010000</span>;<br/>
<span class="in3"></span>}<br/>
<br/>
<span class="in3"></span><span class="keyword">switch</span> (<span class="var">f</span>.<span class="fn">style</span>()) {<br/>
<span class="in4"></span><span class="keyword">case</span> <span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">i_type</span>:<br/>
<span class="in5"></span><span class="var">state</span>.<span class="fn">mod_code</span>(<span class="var">f</span>.<span class="fn">position</span>()) |= <span class="var">value</span> &lt;&lt; <span class="num">20</span>;<br/>
<span class="in5"></span><span class="keyword">break</span>;<br/>
<span class="in4"></span><span class="keyword">case</span> <span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">s_type</span>:<br/>
<span class="in5"></span><span class="var">state</span>.<span class="fn">mod_code</span>(<span class="var">f</span>.<span class="fn">position</span>()) |= ((<span class="var">value</span> &amp; <span class="num">0xfe0</span>) &lt;&lt; (<span class="num">25</span> - <span class="num">5</span>)) | ((<span class="var">value</span> &amp; <span class="num">0x1f</span>) &lt;&lt; <span class="num">7</span>);<br/>
<span class="in5"></span><span class="keyword">break</span>;<br/>
<span class="in4"></span><span class="keyword">case</span> <span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">b_type</span>:<br/>
<span class="in5"></span><span class="var">state</span>.<span class="fn">mod_code</span>(<span class="var">f</span>.<span class="fn">position</span>()) |= ((<span class="var">value</span> &amp; <span class="num">0x1000</span>) &lt;&lt; (<span class="num">31</span> - <span class="num">12</span>)) | ((<span class="var">value</span> &amp; <span class="num">0x7e0</span>) &lt;&lt; (<span class="num">25</span> - <span class="num">5</span>)) | ((<span class="var">value</span> &amp; <span class="num">0x1e</span>) &lt;&lt; (<span class="num">8</span> - <span class="num">1</span>)) | ((<span class="var">value</span> &amp; <span class="num">0x800</span>) &gt;&gt; (<span class="num">11</span> - <span class="num">7</span>));<br/>
<span class="in5"></span><span class="keyword">break</span>;<br/>
<span class="in4"></span><span class="keyword">case</span> <span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">u_type</span>:<br/>
<span class="in5"></span><span class="var">state</span>.<span class="fn">mod_code</span>(<span class="var">f</span>.<span class="fn">position</span>()) |= <span class="var">value</span> &amp; <span class="num">0xfffff000</span>;<br/>
<span class="in5"></span><span class="keyword">break</span>;<br/>
<span class="in4"></span><span class="keyword">case</span> <span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">j_type</span>:<br/>
<span class="in5"></span><span class="var">state</span>.<span class="fn">mod_code</span>(<span class="var">f</span>.<span class="fn">position</span>()) |= ((<span class="var">value</span> &amp; <span class="num">0x100000</span>) &lt;&lt; (<span class="num">31</span> - <span class="num">20</span>)) | ((<span class="var">value</span> &amp; <span class="num">0x7fe</span>) &lt;&lt; (<span class="num">21</span> - <span class="num">1</span>)) | ((<span class="var">value</span> &amp; <span class="num">0x800</span>) &lt;&lt; (<span class="num">20</span> - <span class="num">11</span>)) | (<span class="var">value</span> &amp; <span class="num">0xff000</span>);<br/>
<span class="in5"></span><span class="keyword">break</span>;<br/>
<span class="in4"></span><span class="keyword">default</span>:<br/>
<span class="in5"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"unimplemented mode\n"</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">needed by main</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">private state</span>)</span><br/>
<span class="in1"></span><span class="type">Forwards</span> <span class="var">_forwards</span>;<br/>
<span class="macro">@End(<span class="name">private state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">special macros</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">e</span>.<span class="fn">str</span>() == <span class="str">"fwdgoto"</span>) {<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">label</span> { <span class="var">items</span>[<span class="var">k</span> + <span class="num">1</span>] };<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">label</span>.<span class="fn">type</span>() == <span class="type">Item_Type</span>::<span class="var">t_string</span>) {<br/>
<span class="in3"></span><span class="var">_forwards</span>.<span class="fn">emplace_back</span>(<br/>
<span class="in4"></span><span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">j_type</span>, <span class="fn">code_size</span>(), <span class="var">label</span>.<span class="fn">str</span>(), <span class="num">true</span><br/>
<span class="in3"></span>);<br/>
<span class="in3"></span><span class="keyword">continue</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">e</span>.<span class="fn">str</span>() == <span class="str">"fwdcndgoto"</span>) {<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">label</span> { <span class="var">items</span>[<span class="var">k</span> + <span class="num">6</span>] };<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">label</span>.<span class="fn">type</span>() == <span class="type">Item_Type</span>::<span class="var">t_string</span>) {<br/>
<span class="in3"></span><span class="var">_forwards</span>.<span class="fn">emplace_back</span>(<br/>
<span class="in4"></span><span class="type">Forward</span>::<span class="type">Cmd_Style</span>::<span class="var">b_type</span>, <span class="fn">code_size</span>(), <span class="var">label</span>.<span class="fn">str</span>(), <span class="num">true</span><br/>
<span class="in3"></span>);<br/>
<span class="in3"></span><span class="keyword">continue</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">special macros</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">public state</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">fix_forwards</span>() {<br/>
<span class="in2"></span><span class="var">_forwards</span>.<span class="fn">fill</span>(<span class="var">_macros</span>, *<span class="var">this</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">public state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">main</span>)</span><br/>
<span class="in1"></span><span class="var">s</span>.<span class="fn">fix_forwards</span>();<br/>
<span class="macro">@End(<span class="name">main</span>)</span><br/>
</code></div>
</div>
</body>
</html>
