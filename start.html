<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>First Code fragments</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>First Code fragments</h1>
<div class="slides">
<div>
<div>
<h1>First Code fragments</h1>
</div>
<ul><li>
start low-level with the first unit-test
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">file: ll.cpp</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">needed by main</span>)</span>;<br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">main</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">argc</span>, <span class="type">const</span> <span class="type">char</span> *<span class="var">argv</span>[]<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">main</span>)</span><br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">file: ll.cpp</span>)</span><br/>
</code></div>
<ul><li>
the start is easy in C++
</li><li>
a naked <code><span class="fn">main</span></code> function with arguments array
</li><li>
it will call some other things that must be declared before the  <code><span class="fn">main</span></code> function
</li><li>
so there is a fragment for prerequisites and the content
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">main</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">unit-tests</span>)</span><br/>
<span class="macro">@end(<span class="name">main</span>)</span><br/>
</code></div>
<ul><li>
first some unit-tests are performed at every start of low-level
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">needed by main</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">cassert</span>&gt;<br/>
<span class="macro">@end(<span class="name">needed by main</span>)</span><br/>
</code></div>
<ul><li>
the unit-tests need the <code><span class="fn">assert</span></code>-macro
</li></ul>
</div>
</div>
<h2>Parsing a single line</h2>
<div class="slides">
<div>
<div>
<h2>Parsing a single line</h2>
</div>
<ul><li>
the first test focuses on parsing a single line
</li><li>
other code is responsible for reading files and extract the low-level  lines from it
</li></ul>
</div>
</div>
<p>The parsing is part of a <code><span class="type">State</span></code> object that contains all generated machine instructions.
</p>
<div class="slides">
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by main</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">needed by state</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">State</span> {<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">private state</span>)</span><br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">public state</span>)</span><br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">state impl</span>)</span>;<br/>
<span class="macro">@end(<span class="name">needed by main</span>)</span><br/>
</code></div>
<ul><li>
the <code><span class="type">State</span></code> class can contain private and public members
</li><li>
also a fragment is reserved for containing the implementation of  non-inlined methods
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">string</span>&gt;<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
<ul><li>
<code><span class="fn">add_line</span></code> needs <code><span class="type">std</span>::<span class="type">string</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">public state</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add_line</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">line</span><br/>
<span class="in1"></span>);<br/>
<span class="macro">@end(<span class="name">public state</span>)</span><br/>
</code></div>
<ul><li>
method to consume one line with one instruction
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">state impl</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="type">State</span>::<span class="fn">add_line</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">add line</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">state impl</span>)</span><br/>
</code></div>
<ul><li>
populate the empty implementation when dependencies are present
</li></ul>
</div>
</div>
<p>Where will the machine instructions be written? To abstract the storage away from the code generation a new method stores the machine code.
</p>
<div class="slides">
<div><div>
<code>
<span class="macro">@def(<span class="name">private state</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add_machine</span>(<span class="type">int</span> <span class="var">instr</span>);<br/>
<span class="macro">@end(<span class="name">private state</span>)</span><br/>
</code></div>
<ul><li>
adding one machine instruction to the current output
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">state impl</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="type">State</span>::<span class="fn">add_machine</span>(<span class="type">int</span> <span class="var">instr</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">add machine</span>)</span><br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">state impl</span>)</span><br/>
</code></div>
<ul><li>
populate empty implementation when dependencies are present
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">public state</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">code storage impl</span>)</span><br/>
<span class="macro">@end(<span class="name">public state</span>)</span><br/>
</code></div>
<ul><li>
first a simple code storage mechanism will be used
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">vector</span>&gt;<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
<ul><li>
simple code storage needs <code><span class="type">std</span>::<span class="type">vector</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">code storage impl</span>)</span><br/>
<span class="in1"></span><span class="keyword">private</span>:<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">vector</span>&lt;<span class="type">int</span>&gt; <span class="var">code</span>;<br/>
<span class="macro">@end(<span class="name">code storage impl</span>)</span><br/>
</code></div>
<ul><li>
code is stored in one big array
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">code storage impl</span>)</span><br/>
<span class="in1"></span><span class="keyword">public</span>:<br/>
<span class="in2"></span><span class="type">int</span> <span class="fn">code_size</span>() <span class="type">const</span> {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">static_cast</span>&lt;<span class="type">int</span>&gt;(<br/>
<span class="in4"></span><span class="var">code</span>.<span class="fn">size</span>()<br/>
<span class="in3"></span>);<br/>
<span class="in2"></span>}<br/>
<span class="macro">@end(<span class="name">code storage impl</span>)</span><br/>
</code></div>
<ul><li>
code size is the size of the array
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">code storage impl</span>)</span><br/>
<span class="in1"></span><span class="keyword">public</span>:<br/>
<span class="in2"></span><span class="type">int</span> <span class="fn">get_code</span>(<span class="type">int</span> <span class="var">pos</span>) <span class="type">const</span> {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">code</span>[<span class="var">pos</span>];<br/>
<span class="in2"></span>}<br/>
<span class="macro">@end(<span class="name">code storage impl</span>)</span><br/>
</code></div>
<ul><li>
machine instructions can be accessed directly from the array
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">add machine</span>)</span><br/>
<span class="in1"></span><span class="var">code</span>.<span class="fn">push_back</span>(<span class="var">instr</span>);<br/>
<span class="macro">@end(<span class="name">add machine</span>)</span><br/>
</code></div>
<ul><li>
simple implementation just saves the data
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by main</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">assert_line</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">line</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">expected</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">assert line</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">needed by main</span>)</span><br/>
</code></div>
<ul><li>
simple helper function to check that some source code generates the  expected instruction
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">unit-tests</span>)</span><br/>
<span class="in1"></span><span class="fn">assert_line</span>(<br/>
<span class="in2"></span><span class="str">"%x4 &lt;- %x2 + %x3"</span>,<br/>
<span class="in2"></span><span class="num">0x00310233</span><br/>
<span class="in1"></span>);<br/>
<span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
the first test checks that a simple register add can be parsed
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">assert line</span>)</span><br/>
<span class="in1"></span><span class="type">State</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="var">s</span>.<span class="fn">add_line</span>(<span class="var">line</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">s</span>.<span class="fn">code_size</span>() == <span class="num">1</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">s</span>.<span class="fn">get_code</span>(<span class="num">0</span>) == <span class="var">expected</span>);<br/>
<span class="macro">@end(<span class="name">assert line</span>)</span><br/>
</code></div>
<ul><li>
instantiate a state and let it parse the line
</li></ul>
</div>
</div>
<h2>Tokenizing</h2>
<div class="slides">
<div>
<div>
<h2>Tokenizing</h2>
</div>
<ul><li>
split the input line into token
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="type">enum</span> <span class="keyword">class</span> <span class="type">Token_Type</span> {<br/>
<span class="in2"></span><span class="var">unknown</span>,<br/>
<span class="in2"></span><span class="var">becomes</span>,<br/>
<span class="in2"></span><span class="var">plus</span>,<br/>
<span class="in2"></span><span class="var">reg</span>,<br/>
<span class="in2"></span><span class="var">end</span><br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">cctype</span>&gt;<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Tokenizer</span> {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span>::<span class="var">const_iterator</span> <span class="var">_cur</span>;<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span>::<span class="var">const_iterator</span> <span class="var">_end</span>;<br/>
<span class="in3"></span><span class="type">Token_Type</span> <span class="var">_type</span> = <span class="type">Token_Type</span>::<span class="var">unknown</span>;<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">_value</span> = {};<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">Tokenizer</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">s</span>): <span class="var">_cur</span> { <span class="var">s</span>.<span class="fn">begin</span>() }, <span class="var">_end</span> { <span class="var">s</span>.<span class="fn">end</span>() } {<br/>
<span class="in4"></span><span class="fn">next</span>();<br/>
<span class="in3"></span>}<br/>
<span class="in3"></span><span class="type">Token_Type</span> <span class="fn">type</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_type</span>; }<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="fn">value</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_value</span>; }<br/>
<span class="in3"></span><span class="type">void</span> <span class="fn">next</span>() {<br/>
<span class="in4"></span><span class="keyword">while</span> (<span class="var">_cur</span> != <span class="var">_end</span> &amp;&amp; *<span class="var">_cur</span> &lt;= <span class="str">' '</span>) { ++<span class="var">_cur</span>; }<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">_cur</span> == <span class="var">_end</span>) {<br/>
<span class="in5"></span><span class="var">_type</span> = <span class="type">Token_Type</span>::<span class="var">end</span>;<br/>
<span class="in5"></span><span class="keyword">return</span>;<br/>
<span class="in4"></span>}<br/>
<span class="in4"></span><span class="var">_type</span> = <span class="type">Token_Type</span>::<span class="var">unknown</span>;<br/>
<span class="in4"></span><span class="keyword">if</span> (*<span class="var">_cur</span> == <span class="str">'&lt;'</span>) {<br/>
<span class="in5"></span><span class="keyword">if</span> (++<span class="var">_cur</span> != <span class="var">_end</span>) {<br/>
<span class="in6"></span><span class="keyword">if</span> (*<span class="var">_cur</span> == <span class="str">'-'</span>) {<br/>
<span class="in7"></span><span class="var">_type</span> = <span class="type">Token_Type</span>::<span class="var">becomes</span>;<br/>
<span class="in7"></span>++<span class="var">_cur</span>;<br/>
<span class="in6"></span>}<br/>
<span class="in5"></span>}<br/>
<span class="in4"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (*<span class="var">_cur</span> == <span class="str">'+'</span>) {<br/>
<span class="in5"></span><span class="var">_type</span> = <span class="type">Token_Type</span>::<span class="var">plus</span>;<br/>
<span class="in5"></span>++<span class="var">_cur</span>;<br/>
<span class="in4"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (*<span class="var">_cur</span> == <span class="str">'%'</span>) {<br/>
<span class="in5"></span>++<span class="var">_cur</span>;<br/>
<span class="in5"></span><span class="var">_value</span> = {};<br/>
<span class="in5"></span><span class="keyword">while</span> (<span class="var">_cur</span> != <span class="var">_end</span> &amp;&amp; <span class="fn">isalnum</span>(*<span class="var">_cur</span>)) {<br/>
<span class="in6"></span><span class="var">_value</span> += *<span class="var">_cur</span>++;<br/>
<span class="in5"></span>}<br/>
<span class="in5"></span><span class="keyword">if</span> (! <span class="var">_value</span>.<span class="fn">empty</span>()) {<br/>
<span class="in6"></span><span class="var">_type</span> = <span class="type">Token_Type</span>::<span class="var">reg</span>;<br/>
<span class="in5"></span>}<br/>
<span class="in4"></span>}<br/>
<span class="in3"></span>}<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Expression</span> {<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="var">virtual</span> ~<span class="fn">Expression</span>() {}<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Register</span>: <span class="keyword">public</span> <span class="type">Expression</span> {<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">_name</span>;<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">int</span> <span class="var">_nr</span>;<br/>
<span class="in3"></span><br/>
<span class="in3"></span><span class="keyword">static</span> <span class="type">int</span> <span class="fn">nr_from_name</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">name</span>.<span class="fn">empty</span>()) { <span class="keyword">return</span> -<span class="num">1</span>; }<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">name</span> == <span class="str">"x"</span>) { <span class="keyword">return</span> -<span class="num">1</span>; }<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">name</span>[<span class="num">0</span>] != <span class="str">'x'</span>) { <span class="keyword">return</span> -<span class="num">1</span>; }<br/>
<span class="in4"></span><span class="type">int</span> <span class="var">nr</span> = <span class="num">0</span>;<br/>
<span class="in4"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">i</span> = <span class="num">1</span>; <span class="var">i</span> &lt; (<span class="type">int</span>) <span class="var">name</span>.<span class="fn">size</span>(); ++<span class="var">i</span>) {<br/>
<span class="in5"></span><span class="type">char</span> <span class="var">ch</span> = <span class="var">name</span>[<span class="var">i</span>];<br/>
<span class="in5"></span><span class="keyword">if</span> (<span class="var">ch</span> &lt; <span class="str">'0'</span> || <span class="var">ch</span> &gt; <span class="str">'9'</span>) { <span class="keyword">return</span> -<span class="num">1</span>; }<br/>
<span class="in5"></span><span class="var">nr</span> = <span class="var">nr</span> * <span class="num">10</span> + (<span class="var">ch</span> - <span class="str">'0'</span>);<br/>
<span class="in4"></span>}<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">nr</span> &lt; <span class="num">0</span> || <span class="var">nr</span> &gt; <span class="num">31</span>) { <span class="keyword">return</span> -<span class="num">1</span>; }<br/>
<span class="in4"></span><span class="keyword">return</span> <span class="var">nr</span>;<br/>
<span class="in3"></span>}<br/>
<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">Register</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>):<br/>
<span class="in4"></span><span class="var">_name</span> { <span class="var">name</span> },<br/>
<span class="in4"></span><span class="var">_nr</span> { <span class="fn">nr_from_name</span>(<span class="var">name</span>) }<br/>
<span class="in3"></span>{ }<br/>
<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="fn">name</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_name</span>; }<br/>
<span class="in3"></span><span class="type">int</span> <span class="fn">nr</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_nr</span>; }<br/>
<span class="in3"></span><span class="type">bool</span> <span class="fn">is_general</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_nr</span> &gt;= <span class="num">0</span>; }<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">memory</span>&gt;<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">BinaryExpression</span>: <span class="keyword">public</span> <span class="type">Expression</span> {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">_frst</span>;<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">_scnd</span>;<br/>
<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">BinaryExpression</span>(<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">frst</span>,<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">scnd</span><br/>
<span class="in3"></span>): <span class="var">_frst</span> { <span class="type">std</span>::<span class="fn">move</span>(<span class="var">frst</span>) }, <span class="var">_scnd</span> { <span class="type">std</span>::<span class="fn">move</span>(<span class="var">scnd</span>) }<br/>
<span class="in3"></span>{ }<br/>
<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; &amp;<span class="fn">first</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_frst</span>; }<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; &amp;<span class="fn">second</span>() <span class="type">const</span> { <span class="keyword">return</span> <span class="var">_scnd</span>; }<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Assignment</span>: <span class="keyword">public</span> <span class="type">BinaryExpression</span> {<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">Assignment</span>(<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">dst</span>,<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">src</span><br/>
<span class="in3"></span>): <span class="fn">BinaryExpression</span>(<span class="type">std</span>::<span class="fn">move</span>(<span class="var">dst</span>), <span class="type">std</span>::<span class="fn">move</span>(<span class="var">src</span>))<br/>
<span class="in3"></span>{}<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Addition</span>: <span class="keyword">public</span> <span class="type">BinaryExpression</span> {<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="fn">Addition</span>(<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">frst</span>,<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">scnd</span><br/>
<span class="in3"></span>): <span class="fn">BinaryExpression</span>(<span class="type">std</span>::<span class="fn">move</span>(<span class="var">frst</span>), <span class="type">std</span>::<span class="fn">move</span>(<span class="var">scnd</span>))<br/>
<span class="in3"></span>{}<br/>
<span class="in2"></span><br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">iostream</span>&gt;<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="fn">parse</span>(<span class="type">Tokenizer</span> &amp;<span class="var">t</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Expression</span>&gt; <span class="var">result</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">t</span>.<span class="fn">type</span>() != <span class="type">Token_Type</span>::<span class="var">reg</span>) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"expected state\n"</span>;<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">dst</span> = <span class="type">std</span>::<span class="var">make_unique</span>&lt;<span class="type">Register</span>&gt;(<span class="var">t</span>.<span class="fn">value</span>());<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="var">dst</span>-&gt;<span class="fn">is_general</span>()) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"general purpose register expected\n"</span>;<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="var">t</span>.<span class="fn">next</span>();<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">t</span>.<span class="fn">type</span>() == <span class="type">Token_Type</span>::<span class="var">becomes</span>) {<br/>
<span class="in3"></span><span class="var">t</span>.<span class="fn">next</span>();<br/>
<span class="in3"></span><span class="type">auto</span> <span class="var">src</span> = <span class="fn">parse</span>(<span class="var">t</span>);<br/>
<span class="in3"></span><span class="keyword">if</span> (! <span class="var">src</span>) {<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"no expression after &lt;-\n"</span>;<br/>
<span class="in4"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in3"></span><span class="var">result</span> = <span class="type">std</span>::<span class="var">make_unique</span>&lt;<span class="type">Assignment</span>&gt;(<span class="type">std</span>::<span class="fn">move</span>(<span class="var">dst</span>), <span class="type">std</span>::<span class="fn">move</span>(<span class="var">src</span>));<br/>
<span class="in2"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="var">t</span>.<span class="fn">type</span>() == <span class="type">Token_Type</span>::<span class="var">plus</span>) {<br/>
<span class="in3"></span><span class="var">t</span>.<span class="fn">next</span>();<br/>
<span class="in3"></span><span class="type">auto</span> <span class="var">src</span> = <span class="fn">parse</span>(<span class="var">t</span>);<br/>
<span class="in3"></span><span class="keyword">if</span> (! <span class="var">src</span>) {<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"no expression after +\n"</span>;<br/>
<span class="in4"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in3"></span><span class="var">result</span> = <span class="type">std</span>::<span class="var">make_unique</span>&lt;<span class="type">Addition</span>&gt;(<span class="type">std</span>::<span class="fn">move</span>(<span class="var">dst</span>), <span class="type">std</span>::<span class="fn">move</span>(<span class="var">src</span>));<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="var">result</span> = <span class="type">std</span>::<span class="fn">move</span>(<span class="var">dst</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">build_r_cmd</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">funct7</span>, <span class="type">char</span> <span class="var">src2</span>, <span class="type">char</span> <span class="var">src1</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">funct3</span>, <span class="type">char</span> <span class="var">dst</span>, <span class="type">int</span> <span class="var">opcode</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> (<span class="var">funct7</span> &lt;&lt; <span class="num">25</span>) |<br/>
<span class="in3"></span>(<span class="var">src2</span> &lt;&lt; <span class="num">20</span>) | (<span class="var">src1</span> &lt;&lt; <span class="num">15</span>) |<br/>
<span class="in3"></span>(<span class="var">funct3</span> &lt;&lt; <span class="num">12</span>) | (<span class="var">dst</span> &lt;&lt; <span class="num">7</span>) |<br/>
<span class="in3"></span><span class="var">opcode</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">needed by state</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">build_add</span>(<br/>
<span class="in2"></span><span class="type">char</span> <span class="var">dst</span>, <span class="type">char</span> <span class="var">src1</span>, <span class="type">char</span> <span class="var">src2</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">build_r_cmd</span>(<br/>
<span class="in3"></span><span class="num">0x00</span>, <span class="var">src2</span>, <span class="var">src1</span>,<br/>
<span class="in3"></span><span class="num">0x0</span>, <span class="var">dst</span>, <span class="num">0x33</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">needed by state</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">add line</span>)</span><br/>
<span class="in1"></span><span class="type">Tokenizer</span> <span class="var">t</span> { <span class="var">line</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">e</span> = <span class="fn">parse</span>(<span class="var">t</span>);<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">e</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"no statement on line "</span> &lt;&lt; <span class="var">line</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">Assignment</span> *<span class="var">a</span> = <span class="var">dynamic_cast</span>&lt;<span class="type">Assignment</span> *&gt;(&amp;*<span class="var">e</span>);<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">a</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"assignment expected on line "</span> &lt;&lt; <span class="var">line</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">Register</span> *<span class="var">dst</span> = <span class="var">dynamic_cast</span>&lt;<span class="type">const</span> <span class="type">Register</span> *&gt;(&amp;*<span class="var">a</span>-&gt;<span class="fn">first</span>());<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">dst</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"no assignment to register\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">dst</span>-&gt;<span class="fn">is_general</span>()) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"assigned register is not general\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">Addition</span> *<span class="var">o</span> = <span class="var">dynamic_cast</span>&lt;<span class="type">const</span> <span class="type">Addition</span> *&gt;(&amp;*<span class="var">a</span>-&gt;<span class="fn">second</span>());<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">o</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"only addition supported now\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">Register</span> *<span class="var">src1</span> = <span class="var">dynamic_cast</span>&lt;<span class="type">const</span> <span class="type">Register</span> *&gt;(&amp;*<span class="var">o</span>-&gt;<span class="fn">first</span>());<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">src1</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"first op of addition no register\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">src1</span>-&gt;<span class="fn">is_general</span>()) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"first of of addition no general register\n"</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">Register</span> *<span class="var">src2</span> = <span class="var">dynamic_cast</span>&lt;<span class="type">const</span> <span class="type">Register</span> *&gt;(&amp;*<span class="var">o</span>-&gt;<span class="fn">second</span>());<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">src2</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"second op of addition no register\n"</span>;<br/>
<span class="in2"></span><span class="keyword">return</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">src2</span>-&gt;<span class="fn">is_general</span>()) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"second of of addition no general register\n"</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="fn">add_machine</span>(<span class="fn">build_add</span>(<br/>
<span class="in2"></span>(<span class="type">char</span>) <span class="var">dst</span>-&gt;<span class="fn">nr</span>(), (<span class="type">char</span>) <span class="var">src1</span>-&gt;<span class="fn">nr</span>(), (<span class="type">char</span>) <span class="var">src2</span>-&gt;<span class="fn">nr</span>()<br/>
<span class="in1"></span>));<br/>
<span class="macro">@end(<span class="name">add line</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="fn">add</span>(<span class="var">needed</span> <span class="var">by</span> <span class="var">main</span>)<br/>
<span class="in1"></span><span class="fn">put</span>(<span class="var">needed</span> <span class="var">by</span> <span class="var">do</span> <span class="var">riscv</span>)<br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">do_riscv</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">src</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">got</span> = <span class="num">0x00000000</span>;<br/>
<span class="in2"></span><span class="fn">put</span>(<span class="var">do</span> <span class="var">riscv</span>);<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">got</span>;<br/>
<span class="in1"></span>}<br/>
<span class="fn">end</span>(<span class="var">needed</span> <span class="var">by</span> <span class="var">main</span>)<br/>
</code></div>
</div>
</body>
</html>
